# 实验3 PL/0 Compiler 完善与拓展



## 实验内容及分工

1. 完成语法分析中的错误处理
2. 在lab-3所给的拓展任务中，自行挑选数个任务完成，总计需要得到12颗⭐

我们最终完成了所有拓展功能。

### 1. 错误处理

错误处理在lab-2中已经基本完成，lab-3中只进行了一些小的修正，以及对新增内容的错误处理。

每个人各自处理自己实现内容部分的错误处理，郭金涛处理了一些特殊的错误。

### 2. 拓展功能

每个人负责了各自实现功能文法的增加和修改，邓龙收集并统一了所有文法的修改和增加，给出了新的文法方案(`syntax_zh-draft.txt`)，并修改了对应程序内的硬编码产生式(`syntax.h`，`syntax.c`)。

各个部分完成后，邓龙进行了调试和修正。

#### 2.1. 增加数组

邓龙负责了数组部分语法的修改和增添，实现了包括常量数组的定义等的所有数组语法的判别。

数组只支持至二维。

#### 2.2. 增加逻辑运算符

原实验要求有很多难以解决的问题，故我们只实现了所要求功能的部分。我们暂时没有将条件概念一般化，且不允许逻辑表达式出现括号（必须按照非与或优先级递减的方式计算）。

这部分功能的实现由徐煜森完成。

#### 2.3. 增加返回值

很简单，由郭金涛完成。

#### 2.4. 增加else/elif

为了文法的简洁性（不破坏LL(1)性质，也不对文法的基本结构进行大改），我们还加入了关键字`endif`，分支语句必须由`endif`结束。

该部分由徐煜森完成，郭金涛进行了一些修改。

#### 2.5. 增加do while

同样很简单，由郭金涛完成。

#### 2.6. 增加参数传递

目前参数只能为值变量，不能为数组。可传递任意个参数，但无参数时也需要用形如`call a();`的方式调用子过程。

该部分由郭金涛完成。

#### 2.7. 在语法分析中引入负数

很简单，只需略微修改常量的定义和因式。

由郭金涛完成，邓龙完成了与常量数组初始化的结合。



## 遇到的问题



### if/elif/else 对文法性质的破坏

lab-3的选做内容中，一项是增加elif及else关键字。徐煜森注意到若在其中加入‘;’作为分隔，如下风格：

```
procedure fun;
begin
    if a == 1 then
        a := a + 2;
    elif a == 2 then
        a := 0;
    else
        a := a + 1;
end;
```

虽然文法风格和原pl0相符，但是导致文法必不为LL(1)的。（因为提取做公因子后，剩余部分first集和follow集都有';'）

若不用分号分隔，可能写出下列代码：

```
procedure fun;
begin
    if a == 1 then
        a := a + 2
    elif a == 2 then
        a := 0
    else
        a := a + 1;
end;
```

这显然与原pl0文法风格不符（每条语句后都是';'或'.'）。

之前徐煜森已经向助教提出过这个问题，助教认为可以使用第二种文法。

邓龙认为还有一种解决方案，即加入关键字`endif`（或`fi`），if语句必须由`endif`结尾，如下：

```
procedure fun;
begin
    if a == 1 then
        a := a + 2;
    elif a == 2 then
        a := 0;
    else
        a := a + 1;
    endif;
end;
```

这样既统一了代码风格，又维持文法为LL(1)，只需要多增加一个关键字。

这样的风格在很多其它语言也有出现，原pl0中也有begin、end匹配的例子，感觉是个不错的解决方案。

最终我们采用了这样的解决方案。



### 逻辑表达式

若将逻辑表达式统一，会产生一个跨越多层的左递归。要消除该左递归，则文法需要大量改动且变得不清晰。另外`odd`关键字的存在也提示了我们pl0的设计者不希望条件和算数表达式的统一。

最终我们未把算数表达式与逻辑表达式统一，即逻辑表达式不能作为右值赋值。

另外，逻辑表达式中若使用`()`会导致LL(1)性质的破坏，改用其它括号显得不够优雅，我们暂时搁置了这个问题。现在不允许在逻辑表达式中使用括号。



鉴于逻辑表达式中出现了很多问题，我分析了问题出现的原因，都是因为表达式本身的性质与LL(1)文法产生的冲突。我们考虑在编译器中构造一个LR的子分析器来处理表达式问题。该想法暂未实现，若时间充裕会在lab-4中实现。

若用LR分析器，条件概念一般化和括号问题都容易得到解决，表达式文法也无需一层层处理左递归问题，表达式所有问题都能得到圆满解决。



### 文件中止问题

我们使用`PL0Lex_get_token`时没有判断返回值，导致读到EOF仍会继续运行编译器，为了不使编译器误认为不断读到同一个词法符号，当词法分析器读到EOF后，其会将词法符号改为NULL。



## 总结

翻译感觉很难，lab-3已经有很多想法没有实现了，要抓紧时间啊。

